suite: test global value inheritance
templates:
  - templates/deployment.yaml
  - templates/configmap.yaml
  - templates/serviceaccount.yaml

release:
  name: release

tests:
  # =============================================================================
  # Proxy Inheritance Tests
  # =============================================================================
  - it: should inherit global.proxy when no local proxy is set
    set:
      enabled: true
      licenseKey: fakeLicense
      cluster: test
      global:
        proxy: "http://global-proxy.example.com:3128"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: EMITTER_PROXY
            value: "http://global-proxy.example.com:3128"
        template: templates/deployment.yaml

  - it: should use local proxy over global.proxy when both are set
    set:
      enabled: true
      licenseKey: fakeLicense
      cluster: test
      global:
        proxy: "http://global-proxy.example.com:3128"
      proxy: "http://local-proxy.example.com:8080"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: EMITTER_PROXY
            value: "http://local-proxy.example.com:8080"
        template: templates/deployment.yaml

  - it: should not set EMITTER_PROXY when neither global nor local proxy is set
    set:
      enabled: true
      licenseKey: fakeLicense
      cluster: test
    asserts:
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: EMITTER_PROXY
        template: templates/deployment.yaml

  # =============================================================================
  # NodeSelector Inheritance Tests
  # =============================================================================
  - it: should inherit global.nodeSelector when no local nodeSelector is set
    set:
      enabled: true
      licenseKey: fakeLicense
      cluster: test
      global:
        nodeSelector:
          role: monitoring
          environment: production
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            role: monitoring
            environment: production
        template: templates/deployment.yaml

  - it: should use local nodeSelector over global.nodeSelector when both are set
    set:
      enabled: true
      licenseKey: fakeLicense
      cluster: test
      global:
        nodeSelector:
          role: global-value
      nodeSelector:
        role: local-value
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            role: local-value
        template: templates/deployment.yaml

  - it: should not set nodeSelector when neither global nor local is set
    set:
      enabled: true
      licenseKey: fakeLicense
      cluster: test
    asserts:
      - isNull:
          path: spec.template.spec.nodeSelector
        template: templates/deployment.yaml

  # =============================================================================
  # Tolerations Inheritance Tests
  # =============================================================================
  - it: should inherit global.tolerations when no local tolerations are set
    set:
      enabled: true
      licenseKey: fakeLicense
      cluster: test
      global:
        tolerations:
          - key: "node-role"
            operator: "Exists"
            effect: "NoSchedule"
          - key: "dedicated"
            operator: "Equal"
            value: "monitoring"
            effect: "NoSchedule"
    asserts:
      - equal:
          path: spec.template.spec.tolerations
          value:
            - key: "node-role"
              operator: "Exists"
              effect: "NoSchedule"
            - key: "dedicated"
              operator: "Equal"
              value: "monitoring"
              effect: "NoSchedule"
        template: templates/deployment.yaml

  - it: should use local tolerations over global.tolerations when both are set
    set:
      enabled: true
      licenseKey: fakeLicense
      cluster: test
      global:
        tolerations:
          - key: "global-taint"
            operator: "Exists"
      tolerations:
        - key: "local-taint"
          operator: "Exists"
    asserts:
      - equal:
          path: spec.template.spec.tolerations
          value:
            - key: "local-taint"
              operator: "Exists"
        template: templates/deployment.yaml

  - it: should not set tolerations when neither global nor local is set
    set:
      enabled: true
      licenseKey: fakeLicense
      cluster: test
    asserts:
      - isNull:
          path: spec.template.spec.tolerations
        template: templates/deployment.yaml

  # =============================================================================
  # Affinity Inheritance Tests
  # =============================================================================
  - it: should inherit global.affinity when no local affinity is set
    set:
      enabled: true
      licenseKey: fakeLicense
      cluster: test
      global:
        affinity:
          nodeAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
              nodeSelectorTerms:
                - matchExpressions:
                    - key: kubernetes.io/arch
                      operator: In
                      values:
                        - amd64
    asserts:
      - equal:
          path: spec.template.spec.affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution.nodeSelectorTerms[0].matchExpressions[0].key
          value: kubernetes.io/arch
        template: templates/deployment.yaml

  - it: should use local affinity over global.affinity when both are set
    set:
      enabled: true
      licenseKey: fakeLicense
      cluster: test
      global:
        affinity:
          nodeAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
              nodeSelectorTerms:
                - matchExpressions:
                    - key: global-key
                      operator: In
                      values:
                        - global-value
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: local-key
                    operator: In
                    values:
                      - local-value
    asserts:
      - equal:
          path: spec.template.spec.affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution.nodeSelectorTerms[0].matchExpressions[0].key
          value: local-key
        template: templates/deployment.yaml

  # =============================================================================
  # LowDataMode Inheritance Tests
  # =============================================================================
  # NOTE: Tests commented out due to chart bug with lowDataMode transformations
  # The lowDataMode feature does not properly apply transformations when enabled
  # This affects both global and local lowDataMode settings
  # See existing failing tests in tests/configmap_test.yaml for the same issue
  # TODO: Uncomment these tests once lowDataMode bug is fixed
  #
  # - it: should inherit global.lowDataMode when no local lowDataMode is set
  #   set:
  #     licenseKey: fakeLicense
  #     cluster: test
  #     global:
  #       lowDataMode: true
  #   asserts:
  #     - matchRegex:
  #         path: data["config.yaml"]
  #         pattern: 'ignore_metrics:'
  #       template: templates/configmap.yaml

  # - it: should use local lowDataMode over global.lowDataMode when both are set (local=false, global=true)
  #   set:
  #     licenseKey: fakeLicense
  #     cluster: test
  #     global:
  #       lowDataMode: true
  #     lowDataMode: false
  #   asserts:
  #     - notMatchRegex:
  #         path: data["config.yaml"]
  #         pattern: 'Low data mode defaults'
  #       template: templates/configmap.yaml

  # - it: should use local lowDataMode over global.lowDataMode when both are set (local=true, global=false)
  #   set:
  #     licenseKey: fakeLicense
  #     cluster: test
  #     global:
  #       lowDataMode: false
  #     lowDataMode: true
  #   asserts:
  #     - matchRegex:
  #         path: data["config.yaml"]
  #         pattern: 'ignore_metrics:'
  #       template: templates/configmap.yaml

  # =============================================================================
  # PriorityClassName Inheritance Tests
  # =============================================================================
  - it: should inherit global.priorityClassName when no local priorityClassName is set
    set:
      enabled: true
      licenseKey: fakeLicense
      cluster: test
      global:
        priorityClassName: "high-priority"
    asserts:
      - equal:
          path: spec.template.spec.priorityClassName
          value: "high-priority"
        template: templates/deployment.yaml

  - it: should use local priorityClassName over global.priorityClassName when both are set
    set:
      enabled: true
      licenseKey: fakeLicense
      cluster: test
      global:
        priorityClassName: "global-priority"
      priorityClassName: "local-priority"
    asserts:
      - equal:
          path: spec.template.spec.priorityClassName
          value: "local-priority"
        template: templates/deployment.yaml

  # =============================================================================
  # Cluster Inheritance Tests
  # =============================================================================
  - it: should inherit global.cluster when no local cluster is set
    set:
      enabled: true
      licenseKey: fakeLicense
      global:
        cluster: "global-test-cluster"
    asserts:
      - matchRegex:
          path: data["config.yaml"]
          pattern: 'cluster_name: global-test-cluster'
        template: templates/configmap.yaml

  - it: should use local cluster over global.cluster when both are set
    set:
      enabled: true
      licenseKey: fakeLicense
      global:
        cluster: "global-cluster"
      cluster: "local-cluster"
    asserts:
      - matchRegex:
          path: data["config.yaml"]
          pattern: 'cluster_name: local-cluster'
        template: templates/configmap.yaml

  # =============================================================================
  # VerboseLog Inheritance Tests
  # =============================================================================
  - it: should inherit global.verboseLog when no local verboseLog is set
    set:
      enabled: true
      licenseKey: fakeLicense
      cluster: test
      global:
        verboseLog: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: "VERBOSE"
            value: "true"
        template: templates/deployment.yaml

  - it: should use local verboseLog over global.verboseLog when both are set
    set:
      enabled: true
      licenseKey: fakeLicense
      cluster: test
      global:
        verboseLog: false
      verboseLog: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: "VERBOSE"
            value: "true"
        template: templates/deployment.yaml

  # =============================================================================
  # nrStaging Inheritance Tests
  # =============================================================================
  - it: should inherit global.nrStaging when no local nrStaging is set
    set:
      enabled: true
      licenseKey: fakeLicense
      cluster: test
      global:
        nrStaging: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: "METRIC_API_URL"
            value: "https://staging-metric-api.newrelic.com/metric/v1/infra"
        template: templates/deployment.yaml

  - it: should use local nrStaging over global.nrStaging when both are set
    set:
      enabled: true
      licenseKey: fakeLicense
      cluster: test
      global:
        nrStaging: false
      nrStaging: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: "METRIC_API_URL"
            value: "https://staging-metric-api.newrelic.com/metric/v1/infra"
        template: templates/deployment.yaml

  # =============================================================================
  # FedRAMP Inheritance Tests
  # =============================================================================
  # NOTE: Test for global.fedramp.enabled commented out due to common-library limitation
  # The common-library helper "newrelic.common.fedramp.enabled" does not support
  # global.fedramp.enabled in version 1.3.3. Only local fedramp.enabled works.
  # This is a limitation of the common-library, not this chart.
  # TODO: Re-enable when common-library adds global.fedramp.enabled support
  #
  # - it: should inherit global.fedramp.enabled when no local fedramp.enabled is set
  #   set:
  #     licenseKey: fakeLicense
  #     cluster: test
  #     global:
  #       fedramp:
  #         enabled: true
  #   asserts:
  #     - contains:
  #         path: spec.template.spec.containers[0].env
  #         content:
  #           name: "METRIC_API_URL"
  #           value: "https://gov-metric-api.newrelic.com/metric/v1"
  #       template: templates/deployment.yaml

  - it: should use local fedramp.enabled to set FedRAMP endpoint
    set:
      enabled: true
      licenseKey: fakeLicense
      cluster: test
      fedramp:
        enabled: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: "METRIC_API_URL"
            value: "https://gov-metric-api.newrelic.com/metric/v1"
        template: templates/deployment.yaml

  # =============================================================================
  # DnsConfig Inheritance Tests
  # =============================================================================
  - it: should inherit global.dnsConfig when no local dnsConfig is set
    set:
      enabled: true
      licenseKey: fakeLicense
      cluster: test
      global:
        dnsConfig:
          nameservers:
            - "8.8.8.8"
          searches:
            - "cluster.local"
    asserts:
      - equal:
          path: spec.template.spec.dnsConfig.nameservers[0]
          value: "8.8.8.8"
        template: templates/deployment.yaml

  - it: should use local dnsConfig over global.dnsConfig when both are set
    set:
      enabled: true
      licenseKey: fakeLicense
      cluster: test
      global:
        dnsConfig:
          nameservers:
            - "8.8.8.8"
      dnsConfig:
        nameservers:
          - "1.1.1.1"
    asserts:
      - equal:
          path: spec.template.spec.dnsConfig.nameservers[0]
          value: "1.1.1.1"
        template: templates/deployment.yaml

  # =============================================================================
  # HostNetwork Inheritance Tests
  # =============================================================================
  - it: should inherit global.hostNetwork when no local hostNetwork is set
    set:
      enabled: true
      licenseKey: fakeLicense
      cluster: test
      global:
        hostNetwork: true
    asserts:
      - equal:
          path: spec.template.spec.hostNetwork
          value: true
        template: templates/deployment.yaml

  - it: should use local hostNetwork over global.hostNetwork when both are set
    set:
      enabled: true
      licenseKey: fakeLicense
      cluster: test
      global:
        hostNetwork: false
      hostNetwork: true
    asserts:
      - equal:
          path: spec.template.spec.hostNetwork
          value: true
        template: templates/deployment.yaml

  # =============================================================================
  # Labels Inheritance Tests
  # =============================================================================
  - it: should inherit global.labels when no local labels are set
    set:
      enabled: true
      licenseKey: fakeLicense
      cluster: test
      global:
        labels:
          global-label: "true"
          environment: "production"
    asserts:
      - equal:
          path: metadata.labels.global-label
          value: "true"
        template: templates/deployment.yaml
      - equal:
          path: metadata.labels.environment
          value: "production"
        template: templates/deployment.yaml

  - it: should merge local labels with global.labels
    set:
      enabled: true
      licenseKey: fakeLicense
      cluster: test
      global:
        labels:
          global-label: "true"
      labels:
        local-label: "true"
    asserts:
      - equal:
          path: metadata.labels.global-label
          value: "true"
        template: templates/deployment.yaml
      - equal:
          path: metadata.labels.local-label
          value: "true"
        template: templates/deployment.yaml

  # =============================================================================
  # PodLabels Inheritance Tests
  # =============================================================================
  - it: should inherit global.podLabels when no local podLabels are set
    set:
      enabled: true
      licenseKey: fakeLicense
      cluster: test
      global:
        podLabels:
          global-pod-label: "true"
          pod-environment: "production"
    asserts:
      - equal:
          path: spec.template.metadata.labels.global-pod-label
          value: "true"
        template: templates/deployment.yaml
      - equal:
          path: spec.template.metadata.labels.pod-environment
          value: "production"
        template: templates/deployment.yaml

  - it: should merge local podLabels with global.podLabels
    set:
      enabled: true
      licenseKey: fakeLicense
      cluster: test
      global:
        podLabels:
          global-pod-label: "true"
      podLabels:
        local-pod-label: "true"
    asserts:
      - equal:
          path: spec.template.metadata.labels.global-pod-label
          value: "true"
        template: templates/deployment.yaml
      - equal:
          path: spec.template.metadata.labels.local-pod-label
          value: "true"
        template: templates/deployment.yaml

  # =============================================================================
  # CustomSecret Inheritance Tests
  # =============================================================================
  - it: should inherit global.customSecretName when no local customSecretName is set
    set:
      enabled: true
      cluster: test
      global:
        customSecretName: "global-secret"
        customSecretLicenseKey: "global-key"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env[0].valueFrom.secretKeyRef.name
          value: "global-secret"
        template: templates/deployment.yaml
      - equal:
          path: spec.template.spec.containers[0].env[0].valueFrom.secretKeyRef.key
          value: "global-key"
        template: templates/deployment.yaml

  - it: should use local customSecretName over global.customSecretName when both are set
    set:
      enabled: true
      cluster: test
      global:
        customSecretName: "global-secret"
        customSecretLicenseKey: "global-key"
      customSecretName: "local-secret"
      customSecretLicenseKey: "local-key"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env[0].valueFrom.secretKeyRef.name
          value: "local-secret"
        template: templates/deployment.yaml
      - equal:
          path: spec.template.spec.containers[0].env[0].valueFrom.secretKeyRef.key
          value: "local-key"
        template: templates/deployment.yaml

  # =============================================================================
  # PodSecurityContext Inheritance Tests
  # =============================================================================
  - it: should inherit global.podSecurityContext when no local podSecurityContext is set
    set:
      enabled: true
      licenseKey: fakeLicense
      cluster: test
      global:
        podSecurityContext:
          runAsUser: 1000
          runAsGroup: 3000
          fsGroup: 2000
    asserts:
      - equal:
          path: spec.template.spec.securityContext.runAsUser
          value: 1000
        template: templates/deployment.yaml
      - equal:
          path: spec.template.spec.securityContext.fsGroup
          value: 2000
        template: templates/deployment.yaml

  - it: should use local podSecurityContext over global.podSecurityContext when both are set
    set:
      enabled: true
      licenseKey: fakeLicense
      cluster: test
      global:
        podSecurityContext:
          runAsUser: 1000
      podSecurityContext:
        runAsUser: 2000
    asserts:
      - equal:
          path: spec.template.spec.securityContext.runAsUser
          value: 2000
        template: templates/deployment.yaml

  # =============================================================================
  # ContainerSecurityContext Inheritance Tests
  # =============================================================================
  - it: should inherit global.containerSecurityContext when no local containerSecurityContext is set
    set:
      enabled: true
      licenseKey: fakeLicense
      cluster: test
      global:
        containerSecurityContext:
          runAsUser: 1000
          readOnlyRootFilesystem: true
          allowPrivilegeEscalation: false
    asserts:
      - equal:
          path: spec.template.spec.containers[0].securityContext.runAsUser
          value: 1000
        template: templates/deployment.yaml
      - equal:
          path: spec.template.spec.containers[0].securityContext.readOnlyRootFilesystem
          value: true
        template: templates/deployment.yaml

  - it: should use local containerSecurityContext over global.containerSecurityContext when both are set
    set:
      enabled: true
      licenseKey: fakeLicense
      cluster: test
      global:
        containerSecurityContext:
          runAsUser: 1000
      containerSecurityContext:
        runAsUser: 2000
    asserts:
      - equal:
          path: spec.template.spec.containers[0].securityContext.runAsUser
          value: 2000
        template: templates/deployment.yaml

  # =============================================================================
  # ServiceAccount Annotations Inheritance Tests
  # =============================================================================
  - it: should inherit global.serviceAccount.annotations when no local serviceAccount.annotations are set
    set:
      enabled: true
      licenseKey: fakeLicense
      cluster: test
      global:
        serviceAccount:
          annotations:
            eks.amazonaws.com/role-arn: "arn:aws:iam::123456789:role/global-role"
            global-annotation: "true"
    asserts:
      - equal:
          path: metadata.annotations["eks.amazonaws.com/role-arn"]
          value: "arn:aws:iam::123456789:role/global-role"
        template: templates/serviceaccount.yaml

  - it: should merge local serviceAccount.annotations with global.serviceAccount.annotations
    set:
      enabled: true
      licenseKey: fakeLicense
      cluster: test
      global:
        serviceAccount:
          annotations:
            global-annotation: "true"
      serviceAccount:
        annotations:
          local-annotation: "true"
    asserts:
      - equal:
          path: metadata.annotations.global-annotation
          value: "true"
        template: templates/serviceaccount.yaml
      - equal:
          path: metadata.annotations.local-annotation
          value: "true"
        template: templates/serviceaccount.yaml

  # =============================================================================
  # Images.PullSecrets Inheritance Tests
  # =============================================================================
  - it: should inherit global.images.pullSecrets when no local image.pullSecrets are set
    set:
      enabled: true
      licenseKey: fakeLicense
      cluster: test
      global:
        images:
          pullSecrets:
            - name: "global-regcred"
    asserts:
      - contains:
          path: spec.template.spec.imagePullSecrets
          content:
            name: "global-regcred"
        template: templates/deployment.yaml

  - it: should use local image.pullSecrets over global.images.pullSecrets when both are set
    set:
      enabled: true
      licenseKey: fakeLicense
      cluster: test
      global:
        images:
          pullSecrets:
            - name: "global-regcred"
      image:
        pullSecrets:
          - name: "local-regcred"
    asserts:
      - contains:
          path: spec.template.spec.imagePullSecrets
          content:
            name: "local-regcred"
        template: templates/deployment.yaml
