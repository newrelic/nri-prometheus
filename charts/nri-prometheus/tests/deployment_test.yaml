suite: test deployment
templates:
  - templates/deployment.yaml

release:
  name: release

tests:
  - it: adds METRIC_API_URL when nrStaging is true.
    set:
      licenseKey: fakeLicense
      cluster: test
      nrStaging: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content: 
            name: "METRIC_API_URL"
            value: "https://staging-metric-api.newrelic.com/metric/v1/infra"

  - it: adds pod labels selectors.
    set:
      licenseKey: fakeLicense
      cluster: test
    asserts:
      - equal:
          path: spec.selector.matchLabels
          value: 
            app.kubernetes.io/instance: release
            app.kubernetes.io/name: nri-prometheus
  
  - it: adds pod security context if specified in values.
    set:
      licenseKey: fakeLicense
      cluster: test
      podSecurityContext:
        foo: bar
    asserts:
      - equal:
          path: spec.template.spec.securityContext
          value: 
            foo: bar
  
  - it: adds securityContext if specified in values.
    set:
      licenseKey: fakeLicense
      cluster: test
      containerSecurityContext:
        foo: bar
    asserts:
      - equal:
          path: spec.template.spec.containers[0].securityContext
          value:
            foo: bar
